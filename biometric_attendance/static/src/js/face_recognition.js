// Sistema de reconocimiento facial para kiosco biom√©trico
// Compatible con Odoo 17 - JavaScript puro sin dependencias

(function() {
    'use strict';
    
    console.log('üéØ Cargando sistema biom√©trico...');
    
    window.BiometricKiosk = {
        video: null,
        canvas: null,
        stream: null,
        faceapi_loaded: false,
        models_loaded: false,
        initialized: false,

        init: function() {
            if (this.initialized) {
                console.log('‚ö†Ô∏è Sistema ya inicializado');
                return;
            }
            
            console.log('üöÄ Inicializando sistema biom√©trico...');
            this.initialized = true;
            
            // Inicializar cuando el DOM est√© listo
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', this.start.bind(this));
            } else {
                this.start();
            }
        },

        start: function() {
            console.log('‚ñ∂Ô∏è Iniciando sistema biom√©trico...');
            
            // Verificar si estamos en la p√°gina del kiosco
            if (!document.getElementById('start_camera')) {
                console.log('‚ÑπÔ∏è No es p√°gina de kiosco, saltando inicializaci√≥n');
                return;
            }
            
            console.log('‚úÖ P√°gina de kiosco detectada');
            
            // Inicializar reloj
            this.updateClock();
            setInterval(this.updateClock.bind(this), 1000);
            
            // Configurar event listeners
            this.setupEventListeners();
            
            // Cargar face-api.js
            this.loadFaceAPI().then(() => {
                this.initializeElements();
            });
        },

        setupEventListeners: function() {
            var self = this;
            console.log('üîó Configurando event listeners...');
            
            // Event listeners para botones del kiosco
            var startBtn = document.getElementById('start_camera');
            var captureBtn = document.getElementById('capture_face');
            var adminBtn = document.getElementById('admin_settings');
            
            if (startBtn) {
                console.log('‚úÖ Bot√≥n iniciar c√°mara encontrado');
                startBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('üé¨ Click en iniciar c√°mara');
                    self.startCamera();
                });
            } else {
                console.error('‚ùå Bot√≥n iniciar c√°mara NO encontrado');
            }
            
            if (captureBtn) {
                console.log('‚úÖ Bot√≥n capturar encontrado');
                captureBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('üì∏ Click en capturar');
                    self.captureAndRecognize();
                });
            }
            
            if (adminBtn) {
                adminBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    self.showAdminSettings();
                });
            }
        },

        loadFaceAPI: function() {
            var self = this;
            console.log('üì¶ Cargando Face-API.js...');
            
            return new Promise(function(resolve) {
                // Verificar si ya est√° cargado
                if (typeof faceapi !== 'undefined') {
                    console.log('‚úÖ Face-API ya est√° cargado');
                    self.faceapi_loaded = true;
                    self.loadModels().then(resolve);
                    return;
                }
                
                // Cargar face-api.js desde CDN
                var script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/face-api.js/0.22.2/face-api.min.js';
                script.onload = function() {
                    console.log('‚úÖ Face-API.js cargado exitosamente');
                    self.faceapi_loaded = true;
                    self.loadModels().then(resolve);
                };
                script.onerror = function() {
                    console.error('‚ùå Error cargando Face-API.js');
                    resolve();
                };
                document.head.appendChild(script);
            });
        },

        loadModels: function() {
            var self = this;
            console.log('üß† Cargando modelos de IA...');
            
            if (typeof faceapi === 'undefined') {
                console.error('‚ùå Face-API.js no est√° disponible');
                return Promise.resolve();
            }

            return Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri('/biometric_attendance/static/models/'),
                faceapi.nets.faceLandmark68Net.loadFromUri('/biometric_attendance/static/models/'),
                faceapi.nets.faceRecognitionNet.loadFromUri('/biometric_attendance/static/models/')
            ]).then(function() {
                self.models_loaded = true;
                console.log('‚úÖ Modelos de IA cargados correctamente');
            }).catch(function(error) {
                console.error('‚ùå Error cargando modelos:', error);
                console.log('‚ÑπÔ∏è Los modelos son opcionales para demostraci√≥n');
            });
        },

        initializeElements: function() {
            console.log('üéØ Inicializando elementos DOM...');
            this.video = document.getElementById('video');
            this.canvas = document.getElementById('canvas');
            
            if (!this.video) {
                console.error('‚ùå Elemento video no encontrado');
            } else {
                console.log('‚úÖ Elemento video encontrado');
            }
            
            if (!this.canvas) {
                console.error('‚ùå Elemento canvas no encontrado');
            } else {
                console.log('‚úÖ Elemento canvas encontrado');
            }
        },

        updateClock: function() {
            var now = new Date();
            var timeString = now.toLocaleString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            var clockElement = document.getElementById('kiosk_clock');
            if (clockElement) {
                clockElement.textContent = timeString;
            }
        },

        startCamera: function() {
            var self = this;
            
            console.log('üé¨ === INICIANDO C√ÅMARA ===');
            
            // Verificar si getUserMedia est√° disponible
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                console.error('‚ùå getUserMedia no est√° disponible en este navegador');
                self.updateStatus('Navegador no compatible con acceso a c√°mara', 'error');
                return;
            }

            // Informaci√≥n del navegador
            console.log('üåê Navegador:', navigator.userAgent);
            console.log('üîó URL:', window.location.href);
            console.log('üîí Protocolo:', window.location.protocol);

            // Verificar si estamos en HTTPS (requerido para c√°mara)
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                console.warn('‚ö†Ô∏è Se recomienda HTTPS para acceso a c√°mara');
            }

            self.updateStatus('Solicitando acceso a c√°mara...', 'info');
            
            // Configuraci√≥n m√°s flexible para c√°mara
            var constraints = {
                video: {
                    width: { ideal: 640, min: 320 },
                    height: { ideal: 480, min: 240 },
                    facingMode: { ideal: 'user' }
                },
                audio: false
            };

            console.log('üìã Restricciones de c√°mara:', constraints);

            navigator.mediaDevices.getUserMedia(constraints)
            .then(function(stream) {
                console.log('‚úÖ ¬°C√°mara accedida exitosamente!');
                console.log('üì∫ Stream obtenido:', stream);
                console.log('üé• Video tracks:', stream.getVideoTracks());
                
                self.stream = stream;
                
                // Verificar que tenemos un elemento video
                if (!self.video) {
                    console.error('‚ùå Elemento video no encontrado');
                    self.updateStatus('Error: elemento video no encontrado', 'error');
                    return;
                }
                
                self.video.srcObject = stream;
                
                // Manejar cuando el video est√° listo
                self.video.onloadedmetadata = function() {
                    console.log('üìä Video metadata cargada:', {
                        width: self.video.videoWidth,
                        height: self.video.videoHeight
                    });
                    
                    self.video.play().then(function() {
                        console.log('‚ñ∂Ô∏è Video reproduci√©ndose correctamente');
                        
                        // Mostrar bot√≥n de captura
                        var startBtn = document.getElementById('start_camera');
                        var captureBtn = document.getElementById('capture_face');
                        
                        if (startBtn) startBtn.style.display = 'none';
                        if (captureBtn) captureBtn.style.display = 'inline-block';
                        
                        self.updateStatus('¬°C√°mara iniciada correctamente! Posicione su rostro', 'success');
                        
                    }).catch(function(playError) {
                        console.error('‚ùå Error reproduciendo video:', playError);
                        self.updateStatus('Error reproduciendo video: ' + playError.message, 'error');
                    });
                };
                
                self.video.onerror = function(videoError) {
                    console.error('‚ùå Error en elemento video:', videoError);
                    self.updateStatus('Error en elemento video', 'error');
                };
                
            })
            .catch(function(error) {
                console.error('‚ùå === ERROR ACCEDIENDO A C√ÅMARA ===');
                console.error('Tipo de error:', error.name);
                console.error('Mensaje:', error.message);
                console.error('Error completo:', error);
                
                var userFriendlyMessage = 'Error al acceder a la c√°mara';
                
                switch(error.name) {
                    case 'NotAllowedError':
                    case 'PermissionDeniedError':
                        userFriendlyMessage = 'üö´ Permisos denegados. Permite el acceso a la c√°mara y recarga la p√°gina';
                        break;
                    case 'NotFoundError':
                    case 'DevicesNotFoundError':
                        userFriendlyMessage = 'üì∑ No se detect√≥ ninguna c√°mara en este dispositivo';
                        break;
                    case 'NotReadableError':
                    case 'TrackStartError':
                        userFriendlyMessage = 'üîí La c√°mara est√° siendo utilizada por otra aplicaci√≥n';
                        break;
                    case 'OverconstrainedError':
                    case 'ConstraintNotSatisfiedError':
                        userFriendlyMessage = '‚öôÔ∏è La configuraci√≥n de c√°mara solicitada no es compatible';
                        break;
                    case 'NotSupportedError':
                        userFriendlyMessage = 'üåê Este navegador no soporta acceso a c√°mara';
                        break;
                    case 'SecurityError':
                        userFriendlyMessage = 'üîê Error de seguridad. ¬øEst√°s usando HTTPS?';
                        break;
                    default:
                        userFriendlyMessage = '‚ùå Error: ' + error.message;
                }
                
                self.updateStatus(userFriendlyMessage, 'error');
                self.showCameraDebugInfo();
            });
        },
        
        showCameraDebugInfo: function() {
            console.log('üîç === INFORMACI√ìN DE DIAGN√ìSTICO ===');
            console.log('üåê URL actual:', window.location.href);
            console.log('üîí Protocolo:', window.location.protocol);
            console.log('üíª Sistema:', {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine
            });
            
            if (navigator.mediaDevices) {
                console.log('‚úÖ MediaDevices disponible');
                
                if (navigator.mediaDevices.enumerateDevices) {
                    navigator.mediaDevices.enumerateDevices()
                    .then(function(devices) {
                        console.log('üì± Dispositivos encontrados:');
                        devices.forEach(function(device, index) {
                            console.log(`${index}: ${device.kind} - ${device.label || 'Sin nombre'}`);
                        });
                    })
                    .catch(function(err) {
                        console.log('‚ùå Error enumerando dispositivos:', err);
                    });
                }
                
                if (navigator.mediaDevices.getSupportedConstraints) {
                    console.log('‚öôÔ∏è Restricciones soportadas:', navigator.mediaDevices.getSupportedConstraints());
                }
            } else {
                console.log('‚ùå MediaDevices NO disponible');
            }
        },

        captureAndRecognize: function() {
            console.log('üì∏ Iniciando captura y reconocimiento');
            this.updateStatus('Funci√≥n de reconocimiento activada - Demo mode', 'info');
            
            // Por ahora solo mostrar mensaje de √©xito para prueba
            setTimeout(() => {
                this.updateStatus('¬°C√°mara funcionando correctamente!', 'success');
            }, 2000);
        },

        updateStatus: function(message, type) {
            console.log(`üìä Status [${type}]: ${message}`);
            var statusElement = document.getElementById('recognition_status');
            if (statusElement) {
                statusElement.innerHTML = `<span>${message}</span>`;
                statusElement.className = 'status_display status_' + type;
            }
        },

        showAdminSettings: function() {
            console.log('‚öôÔ∏è Configuraciones de administrador');
            this.updateStatus('Panel de administraci√≥n - En desarrollo', 'info');
        }
    };

    // Auto-inicializar
    console.log('üéØ Auto-inicializando sistema biom√©trico...');
    window.BiometricKiosk.init();

})();